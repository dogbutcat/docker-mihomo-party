name: Build Multi-Architecture Docker Images

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'VERSION'
      - 'Dockerfile*'
      - '.github/workflows/docker-build.yml'
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
    paths:
      - 'VERSION'
      - 'Dockerfile*'
      - '.github/workflows/docker-build.yml'

env:
  IMAGE_NAME: dogbutcat/mihomo-party

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            dockerfile: Dockerfile
            arch: amd64
          - platform: linux/arm64
            dockerfile: Dockerfile.arm64
            arch: arm64

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è¯»å– VERSION æ–‡ä»¶
    - name: Read VERSION file
      id: version
      run: |
        if [ -f VERSION ]; then
          VERSION=$(cat VERSION | tr -d '\n\r' | xargs)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version from file: $VERSION"
        else
          echo "VERSION file not found"
          exit 1
        fi

    # 3. è®¾ç½® Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 4. ç™»å½•åˆ° Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 5. æ„å»ºå¹¶æ¨é€å•æ¶æ„é•œåƒ
    - name: Build and push ${{ matrix.arch }} image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        platforms: ${{ matrix.platform }}
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-${{ matrix.arch }}
          ${{ env.IMAGE_NAME }}:latest-${{ matrix.arch }}
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
        cache-from: type=gha,scope=${{ matrix.arch }}
        cache-to: type=gha,mode=max,scope=${{ matrix.arch }}

    # 6. è¾“å‡ºæ„å»ºä¿¡æ¯
    - name: Output build info for ${{ matrix.arch }}
      run: |
        echo "ğŸ³ Built ${{ matrix.arch }} image successfully!"
        echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ—ï¸ Platform: ${{ matrix.platform }}"
        echo "ğŸ“„ Dockerfile: ${{ matrix.dockerfile }}"

  # åˆ›å»º manifest åˆå¹¶å¤šæ¶æ„é•œåƒ
  create-manifest:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è¯»å– VERSION æ–‡ä»¶
    - name: Read VERSION file
      id: version
      run: |
        VERSION=$(cat VERSION | tr -d '\n\r' | xargs)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    # 3. ç™»å½•åˆ° Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 4. å­˜åœ¨æ—§çš„å°±åˆ é™¤æ—§çš„ manifest
    - name: Clean up architecture-specific tags
      run: |
        VERSION=${{ steps.version.outputs.version }}
        curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 > /usr/local/bin/regctl
        chmod +x /usr/local/bin/regctl
        echo "Cleaning up temporary tags for version ${VERSION}"
        regctl tag delete ${{ env.IMAGE_NAME }}:${VERSION}-amd64
        regctl tag delete ${{ env.IMAGE_NAME }}:${VERSION}-arm64
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "Cleaning up temporary latest tags"
          regctl tag delete ${{ env.IMAGE_NAME }}:latest-amd64
          regctl tag delete ${{ env.IMAGE_NAME }}:latest-arm64
        fi

    # 5. åˆ›å»ºå¹¶æ¨é€ manifest
    - name: Create and push manifest list
      run: |
        docker buildx imagetools create \
          --tag ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} \
          ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-amd64 \
          ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-arm64

    # 6. åˆ›å»º latest manifest (ä»…ä¸»åˆ†æ”¯)
    - name: Create and push latest manifest
      if: github.ref == 'refs/heads/main'
      run: |
        docker buildx imagetools create \
          --tag ${{ env.IMAGE_NAME }}:latest \
          ${{ env.IMAGE_NAME }}:latest-amd64 \
          ${{ env.IMAGE_NAME }}:latest-arm64

    # 7. è¾“å‡ºæœ€ç»ˆä¿¡æ¯
    - name: Output final info
      run: |
        echo "Multi-architecture image created successfully!"
        echo "Version: ${{ steps.version.outputs.version }}"
        echo "Available tags:"
        echo "  - ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} (multi-arch)"
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "  - ${{ env.IMAGE_NAME }}:latest (multi-arch)"
        fi
        echo ""
        echo "Pull command:"
        echo "  docker pull ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
