# 高性能网络数据包转发优化配置
# 文件位置: /etc/sysctl.d/99-network-performance.conf

# ========== TCP/UDP 缓冲区优化 ==========
# TCP接收缓冲区 (最小值 默认值 最大值)
net.core.rmem_default = 262144
net.core.rmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728

# TCP发送缓冲区 (最小值 默认值 最大值)
net.core.wmem_default = 262144
net.core.wmem_max = 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728

# UDP缓冲区
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192

# ========== 网络队列和处理优化 ==========
# 网络设备接收队列长度
net.core.netdev_max_backlog = 30000

# socket监听队列长度
net.core.somaxconn = 65535

# TCP SYN队列长度
net.ipv4.tcp_max_syn_backlog = 65535

# ========== TCP 性能优化 ==========
# 启用TCP窗口缩放
net.ipv4.tcp_window_scaling = 1

# 启用TCP时间戳
net.ipv4.tcp_timestamps = 1

# 启用SACK选择性确认
net.ipv4.tcp_sack = 1

# 启用Forward RTO-Recovery
net.ipv4.tcp_frto = 2

# TCP拥塞控制算法 (BBR > cubic > reno)
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# TCP连接复用
net.ipv4.tcp_tw_reuse = 1

# 快速回收TIME_WAIT套接字
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_recycle = 0

# TCP保活时间
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# ========== 内存和连接数优化 ==========
# 最大跟踪的连接数
net.netfilter.nf_conntrack_max = 1048576

# 连接跟踪表大小
net.netfilter.nf_conntrack_buckets = 262144

# 连接超时时间
net.netfilter.nf_conntrack_tcp_timeout_established = 300

# 系统最大文件句柄数
fs.file-max = 2097152

# 单个进程最大文件句柄数
fs.nr_open = 1048576

# ========== IP转发和路由优化 ==========
# 启用IP转发
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# 路由缓存优化
net.ipv4.route.gc_timeout = 100

# ARP表大小
net.ipv4.neigh.default.gc_thresh1 = 2048
net.ipv4.neigh.default.gc_thresh2 = 4096
net.ipv4.neigh.default.gc_thresh3 = 8192

# IPv6邻居表
net.ipv6.neigh.default.gc_thresh1 = 2048
net.ipv6.neigh.default.gc_thresh2 = 4096
net.ipv6.neigh.default.gc_thresh3 = 8192

# ========== 网络安全和防护 ==========
# 防止SYN flood攻击
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 2

# ICMP限制
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# 源路由保护
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# 反向路径过滤
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# ========== 高级网络优化 ==========
# TCP Fast Open
net.ipv4.tcp_fastopen = 3

# 启用ECN (显式拥塞通知)
net.ipv4.tcp_ecn = 1

# TCP no delay
net.ipv4.tcp_low_latency = 1

# 网络接口接收数据包的权重
net.core.dev_weight = 64

# BPF JIT编译器
net.core.bpf_jit_enable = 1

# ========== 虚拟内存优化 ==========
# 降低swap使用
vm.swappiness = 10

# 内存过量分配策略
vm.overcommit_memory = 1

# 脏页面回写优化
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 12000

# ========== 系统限制优化 ==========
# 进程可打开的最大文件数
kernel.pid_max = 4194304

# 最大内存映射区域数
vm.max_map_count = 1048576

# 核心转储限制
kernel.core_pattern = /tmp/core-%e-%p-%t

# ========== 针对高性能服务器的额外优化 ==========
# 如果是高性能服务器，可以启用以下设置

# CPU调度优化
kernel.sched_migration_cost_ns = 5000000
kernel.sched_autogroup_enabled = 0

# 中断负载均衡
kernel.nmi_watchdog = 0

# 透明大页 (根据应用决定是否启用)
# vm.transparent_hugepage = never

# ========== 应用配置建议 ==========
# 系统级别文件句柄限制
# 在 /etc/security/limits.conf 添加：
# * soft nofile 1048576
# * hard nofile 1048576
# * soft nproc 1048576  
# * hard nproc 1048576

# 系统服务限制
# 在 /etc/systemd/system.conf 添加：
# DefaultLimitNOFILE=1048576
# DefaultLimitNPROC=1048576